<!DOCTYPE HTML>
<html lang="en-US" >
    
    <head>
        
        <meta charset="UTF-8">
        <title>字典 | 我的笔记</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 1.3.3">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">
        
    
    
    <link rel="next" href="../../redis/replication/README.html" />
    
    
    <link rel="prev" href="../../redis/datastructure/README.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="../../gitbook/style.css">


        
    <div class="book" data-level="3.3.1" data-basepath="../.." data-revision="1416757462491">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
    	
    	
    	

        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../../index.html">
                        <i class="fa fa-check"></i>
                        
                         Introduction
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1" data-path="gitbook/README.html">
            
                
                    <a href="../../gitbook/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                         gitbook的使用
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="1.1" data-path="gitbook/install/README.html">
            
                
                    <a href="../../gitbook/install/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                         安装
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="1.1.1" data-path="gitbook/install/nodejs.html">
            
                
                    <a href="../../gitbook/install/nodejs.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.1.</b>
                        
                         nodejs安装
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.1.2" data-path="gitbook/install/gitbook.html">
            
                
                    <a href="../../gitbook/install/gitbook.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.2.</b>
                        
                         gitbook安装
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="1.2" data-path="gitbook/usage/README.html">
            
                
                    <a href="../../gitbook/usage/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                         使用
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="1.2.1" data-path="gitbook/usage/command.html">
            
                
                    <a href="../../gitbook/usage/command.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.1.</b>
                        
                         gitbook命令
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.2.2" data-path="gitbook/usage/architecture.html">
            
                
                    <a href="../../gitbook/usage/architecture.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.2.</b>
                        
                         gitbook目录结构
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.2.3" data-path="gitbook/usage/output.html">
            
                
                    <a href="../../gitbook/usage/output.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.3.</b>
                        
                         gitbook输出
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="1.3" data-path="gitbook/end/README.html">
            
                
                    <a href="../../gitbook/end/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.</b>
                        
                         小结
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="2" data-path="vim/README.html">
            
                
                    <a href="../../vim/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                         vim插件
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="2.1" data-path="vim/install.html">
            
                
                    <a href="../../vim/install.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                         安装
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.2" data-path="vim/plugin.html">
            
                
                    <a href="../../vim/plugin.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                         我使用的插件
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="3" data-path="redis/README.html">
            
                
                    <a href="../../redis/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                         redis
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="3.1" data-path="redis/aelibrary/README.html">
            
                
                    <a href="../../redis/aelibrary/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                         redis事件库
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="3.1.1" data-path="redis/aelibrary/reactor.html">
            
                
                    <a href="../../redis/aelibrary/reactor.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.1.</b>
                        
                         reactor
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.1.2" data-path="redis/aelibrary/flow.html">
            
                
                    <a href="../../redis/aelibrary/flow.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.2.</b>
                        
                         ae库初始化流程
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.1.3" data-path="redis/aelibrary/eventprocess.html">
            
                
                    <a href="../../redis/aelibrary/eventprocess.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.3.</b>
                        
                         ae库事件处理
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="3.2" data-path="redis/presistence/README.html">
            
                
                    <a href="../../redis/presistence/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                         rdb &amp; aof
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="3.2.1" data-path="redis/presistence/rdb.html">
            
                
                    <a href="../../redis/presistence/rdb.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.1.</b>
                        
                         rdb相关的处理
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.2.2" data-path="redis/presistence/aof.html">
            
                
                    <a href="../../redis/presistence/aof.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.2.</b>
                        
                         aof相关处理
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.2.3" data-path="redis/presistence/advantagesAndDisadvantages.html">
            
                
                    <a href="../../redis/presistence/advantagesAndDisadvantages.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.3.</b>
                        
                         rdb&amp;aof优缺点
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="3.3" data-path="redis/datastructure/README.html">
            
                
                    <a href="../../redis/datastructure/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.3.</b>
                        
                         redis数据结构
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter active" data-level="3.3.1" data-path="redis/datastructure/dict.html">
            
                
                    <a href="../../redis/datastructure/dict.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.3.1.</b>
                        
                         字典
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="3.4" data-path="redis/replication/README.html">
            
                
                    <a href="../../redis/replication/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.4.</b>
                        
                         replication
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="3.4.1" data-path="redis/replication/configuration.html">
            
                
                    <a href="../../redis/replication/configuration.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.4.1.</b>
                        
                         replication相关的配置
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.4.2" data-path="redis/replication/principle.html">
            
                
                    <a href="../../redis/replication/principle.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.4.2.</b>
                        
                         replication的运作原理
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.4.3" data-path="redis/replication/PartialResynchronization.html">
            
                
                    <a href="../../redis/replication/PartialResynchronization.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.4.3.</b>
                        
                         replication部分同步
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="3.5" data-path="redis/others/README.html">
            
                
                    <a href="../../redis/others/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.5.</b>
                        
                         others
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="3.5.1" data-path="redis/others/closeAofFile.html">
            
                
                    <a href="../../redis/others/closeAofFile.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.5.1.</b>
                        
                         redis关闭旧aof文件时的处理
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.5.2" data-path="redis/others/memory.html">
            
                
                    <a href="../../redis/others/memory.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.5.2.</b>
                        
                         redis内存处理
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="3.6" data-path="redis/end/README.html">
            
                
                    <a href="../../redis/end/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.6.</b>
                        
                         小结
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Published using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle share dropdown"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">Twitter</button>
                <button type="button" data-sharing="google-plus" class="button">Google</button>
                <button type="button" data-sharing="facebook" class="button">Facebook</button>
                <button type="button" data-sharing="weibo" class="button">Weibo</button>
                <button type="button" data-sharing="instapaper" class="button">Instapaper</button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../../" >我的笔记</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-gitbook_17">
                    
                        <h1 id="redis">redis字典的实现</h1>
<p>hashtable在redis中占有非常重要的地位。其db就是一个大的字典。其实现的渐进式rehash更是值得我们学习。</p>
<h2 id="redis-dict">redis dict涉及的数据结构</h2>
<p>dict主要涉及到的数据结构如下:</p>
<pre><code class="lang-c"><span class="hljs-comment">// hash table的项</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> dictEntry {
    <span class="hljs-keyword">void</span> *key;
    <span class="hljs-keyword">union</span> {
        <span class="hljs-keyword">void</span> *val;
        uint64_t u64;
        int64_t s64;
    } v;
    <span class="hljs-keyword">struct</span> dictEntry *next;
} dictEntry;
</code></pre>
<pre><code class="lang-c"><span class="hljs-comment">// hash的类型,不同的字典有不同的hash类型</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> dictType {
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> (*hashFunction)(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *key);
    <span class="hljs-keyword">void</span> *(*keyDup)(<span class="hljs-keyword">void</span> *privdata, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *key);
    <span class="hljs-keyword">void</span> *(*valDup)(<span class="hljs-keyword">void</span> *privdata, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *obj);
    <span class="hljs-keyword">int</span> (*keyCompare)(<span class="hljs-keyword">void</span> *privdata, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *key1, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *key2);
    <span class="hljs-keyword">void</span> (*keyDestructor)(<span class="hljs-keyword">void</span> *privdata, <span class="hljs-keyword">void</span> *key);
    <span class="hljs-keyword">void</span> (*valDestructor)(<span class="hljs-keyword">void</span> *privdata, <span class="hljs-keyword">void</span> *obj);
} dictType;
</code></pre>
<pre><code class="lang-c"><span class="hljs-comment">// hash表</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> dictht {
    dictEntry **table;
    <span class="hljs-comment">// 指针数组的大小</span>
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> size;
    <span class="hljs-comment">// 指针数组的长度掩码，用于计算索引值</span>
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> sizemask;
    <span class="hljs-comment">// 哈希表现有的节点数量</span>
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> used;
} dictht;
</code></pre>
<pre><code class="lang-c"><span class="hljs-comment">// 一个字典有两个hash表，用于渐进式的rehash</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> dict {
    <span class="hljs-comment">// 特定于类型的处理函数</span>
    dictType *type;
    <span class="hljs-comment">// 类型处理函数的私有数据</span>
    <span class="hljs-keyword">void</span> *privdata;
    <span class="hljs-comment">// 哈希表（2个）</span>
    dictht ht[<span class="hljs-number">2</span>];
    <span class="hljs-comment">// 记录 rehash 进度的标志，值为-1 表示 rehash 未进行</span>
    <span class="hljs-keyword">int</span> rehashidx;
    <span class="hljs-comment">// 当前正在运作的安全迭代器数量</span>
    <span class="hljs-keyword">int</span> iterators;
} dict;
</code></pre>
<h2 id="redis-dict">redis dict的部分操作</h2>
<h3 id="dict">dict的扩容</h3>
<p><strong>什么时候会扩容</strong></p>
<p>每次在添加元素的时候(dictAdd,dictAddRaw)时候，会调用_dictExpandIfNeeded函数,_dictExpandIfNeeded函数会调用dictExpand函数，该函数会将rehashidx置为0，然后就会启动rehash过程。</p>
<pre><code class="lang-c"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> _dictExpandIfNeeded(dict *d)
{
    <span class="hljs-comment">// 已经在渐进式 rehash 当中，直接返回</span>
    <span class="hljs-keyword">if</span> (dictIsRehashing(d)) <span class="hljs-keyword">return</span> DICT_OK;

    <span class="hljs-comment">// 如果哈希表为空，那么将它扩展为初始大小</span>
    <span class="hljs-keyword">if</span> (d-&gt;ht[<span class="hljs-number">0</span>].size == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> dictExpand(d, DICT_HT_INITIAL_SIZE);

    <span class="hljs-comment">// 如果哈希表ç=acp#onPopupPost()</span>
    <span class="hljs-comment">// 已用节点数 &gt;= 哈希表的大小，</span>
    <span class="hljs-comment">// 并且以下条件任一个为真：</span>
    <span class="hljs-comment">//   1) dict_can_resize 为真</span>
    <span class="hljs-comment">//   2) 已用节点数除以哈希表大小之比大于</span>
    <span class="hljs-comment">//      dict_force_resize_ratio(默认5)</span>
    <span class="hljs-comment">// 那么调用 dictExpand 对哈希表进行扩展</span>
    <span class="hljs-comment">// 扩展的体积至少为已使用节点数的两倍</span>
    <span class="hljs-keyword">if</span> (d-&gt;ht[<span class="hljs-number">0</span>].used &gt;= d-&gt;ht[<span class="hljs-number">0</span>].size &amp;&amp;
        (dict_can_resize ||
         d-&gt;ht[<span class="hljs-number">0</span>].used/d-&gt;ht[<span class="hljs-number">0</span>].size &gt; dict_force_resize_ratio))
    {
        <span class="hljs-keyword">return</span> dictExpand(d, d-&gt;ht[<span class="hljs-number">0</span>].used*<span class="hljs-number">2</span>);
    }
    <span class="hljs-keyword">return</span> DICT_OK;
}
</code></pre>
<pre><code class="lang-c"><span class="hljs-keyword">int</span> dictExpand(dict *d, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> size)
{
    dictht n; <span class="hljs-comment">/* the new hash table */</span>

    <span class="hljs-comment">// 计算哈希表的真实大小</span>
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> realsize = _dictNextPower(size);
    <span class="hljs-comment">/* the size is invalid if it is smaller than the number of
     * elements already inside the hash table */</span>
    <span class="hljs-keyword">if</span> (dictIsRehashing(d) || d-&gt;ht[<span class="hljs-number">0</span>].used &gt; size)
        <span class="hljs-keyword">return</span> DICT_ERR;

    <span class="hljs-comment">/* Allocate the new hash table and initialize all pointers to NULL */</span>
    n.size = realsize;
    n.sizemask = realsize-<span class="hljs-number">1</span>;
    n.table = zcalloc(realsize*<span class="hljs-keyword">sizeof</span>(dictEntry*));
    n.used = <span class="hljs-number">0</span>;

    <span class="hljs-comment">/* Is this the first initialization? If so it's not really a rehashing
     * we just set the first hash table so that it can accept keys. */</span>
    <span class="hljs-comment">// 如果 ht[0] 为空，那么这就是一次创建新哈希表行为</span>
    <span class="hljs-comment">// 将新哈希表设置为 ht[0] ，然后返回</span>
    <span class="hljs-keyword">if</span> (d-&gt;ht[<span class="hljs-number">0</span>].table == NULL) {
        d-&gt;ht[<span class="hljs-number">0</span>] = n;
        <span class="hljs-keyword">return</span> DICT_OK;
    }

    <span class="hljs-comment">/* Prepare a second hash table for incremental rehashing */</span>
    <span class="hljs-comment">// 如果 ht[0] 不为空，那么这就是一次扩展字典的行为</span>
    <span class="hljs-comment">// 将新哈希表设置为 ht[1] ，并打开 rehash 标识</span>
    d-&gt;ht[<span class="hljs-number">1</span>] = n;
    d-&gt;rehashidx = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">return</span> DICT_OK;
}
</code></pre>
<p><strong>扩容过程什么时候进行</strong></p>
<p>当rehashidx在dictExpand中被置为0时，由下面三个函数完成扩容的工作。</p>
<ol>
<li>int dictRehash(dict *d, int n);</li>
<li>int dictRehashMilliseconds(dict *d, int ms);</li>
<li>void _dictRehashStep(dict *d);</li>
</ol>
<p>dictRehash执行的是n步rehash,即dictRehash每执行一次，会移动n个hash桶. dictRehashMilliseconds在serverCron中会被调用. _dictRehashStep在每次增，删，查的过程都会被执行一次。</p>
<p><strong>扩容进行的过程</strong></p>
<p>扩容的具体过程是在dictRehash函数中完成的。</p>
<pre><code class="lang-c"><span class="hljs-keyword">int</span> dictRehash(dict *d, <span class="hljs-keyword">int</span> n) {
    <span class="hljs-keyword">if</span> (!dictIsRehashing(d)) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">while</span>(n--) {
        dictEntry *de, *nextde;

        <span class="hljs-comment">// 如果 ht[0] 已经为空，那么迁移完毕</span>
        <span class="hljs-comment">// 用 ht[1] 代替原来的 ht[0]</span>
        <span class="hljs-keyword">if</span> (d-&gt;ht[<span class="hljs-number">0</span>].used == <span class="hljs-number">0</span>) {

            <span class="hljs-comment">// 释放 ht[0] 的哈希表数组</span>
            zfree(d-&gt;ht[<span class="hljs-number">0</span>].table);

            <span class="hljs-comment">// 将 ht[0] 指向 ht[1]</span>
            d-&gt;ht[<span class="hljs-number">0</span>] = d-&gt;ht[<span class="hljs-number">1</span>];

            <span class="hljs-comment">// 清空 ht[1] 的指针</span>
            _dictReset(&amp;d-&gt;ht[<span class="hljs-number">1</span>]);

            <span class="hljs-comment">// 关闭 rehash 标识</span>
            d-&gt;rehashidx = -<span class="hljs-number">1</span>;

            <span class="hljs-comment">// 通知调用者， rehash 完毕</span>
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }

        assert(d-&gt;ht[<span class="hljs-number">0</span>].size &gt; (<span class="hljs-keyword">unsigned</span>)d-&gt;rehashidx);
        <span class="hljs-comment">// 移动到数组中首个不为 NULL 链表的索引上</span>
        <span class="hljs-keyword">while</span>(d-&gt;ht[<span class="hljs-number">0</span>].table[d-&gt;rehashidx] == NULL) d-&gt;rehashidx++;
        <span class="hljs-comment">// 指向链表头</span>
        de = d-&gt;ht[<span class="hljs-number">0</span>].table[d-&gt;rehashidx];
        <span class="hljs-comment">// 将链表内的所有元素从 ht[0] 迁移到 ht[1]</span>
        <span class="hljs-comment">// 因为桶内的元素通常只有一个，或者不多于某个特定比率</span>
        <span class="hljs-comment">// 所以可以将这个操作看作 O(1)</span>
        <span class="hljs-keyword">while</span>(de) {
            <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> h;

            nextde = de-&gt;next;

            <span class="hljs-comment">/* Get the index in the new hash table */</span>
            <span class="hljs-comment">// 计算元素在 ht[1] 的哈希值</span>
            h = dictHashKey(d, de-&gt;key) &amp; d-&gt;ht[<span class="hljs-number">1</span>].sizemask;

            <span class="hljs-comment">// 添加节点到 ht[1] ，调整指针</span>
            de-&gt;next = d-&gt;ht[<span class="hljs-number">1</span>].table[h];
            d-&gt;ht[<span class="hljs-number">1</span>].table[h] = de;

            <span class="hljs-comment">// 更新计数器</span>
            d-&gt;ht[<span class="hljs-number">0</span>].used--;
            d-&gt;ht[<span class="hljs-number">1</span>].used++;

            de = nextde;
        }

        <span class="hljs-comment">// 设置指针为 NULL ，方便下次 rehash 时跳过</span>
        d-&gt;ht[<span class="hljs-number">0</span>].table[d-&gt;rehashidx] = NULL;

        <span class="hljs-comment">// 前进至下一索引</span>
        d-&gt;rehashidx++;
    }

    <span class="hljs-comment">// 通知调用者，还有元素等待 rehash</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
}
</code></pre>
<p><strong>others</strong></p>
<ol>
<li>对于查找,删除操作，如果正在进行rehash，则查找操作会涉及到ht[0]和ht[1]。</li>
<li>对于添加操作，如果正在进行rehash，则直接添加到ht[1]。</li>
<li>dict.c中有个变量dict_can_resize控制着是否允许自动调整hash表的大小，该变量的改变主要靠如下两个函数：<pre><code class="lang-c"> <span class="hljs-keyword">void</span> dictEnableResize(<span class="hljs-keyword">void</span>) {
     dict_can_resize = <span class="hljs-number">1</span>;
 }
 <span class="hljs-keyword">void</span> dictDisableResize(<span class="hljs-keyword">void</span>) {
     dict_can_resize = <span class="hljs-number">0</span>;
 }
</code></pre>
 在系统运行有后台进程时，不允许自动自动调整大小，这是为了为了使得类linux系统的copy-on-write有更好的性能（没有调整大小， 就没有rehash，这样父进程的db没有改变，子进程就不需要真的copy）。在后台子进程退出后，又会允许resize。</li>
</ol>
<h3 id="dict">dict缩容</h3>
<p>在redis中，hashtable不是只能扩容，还能够缩容。其过程和扩容一样：</p>
<ol>
<li>创建一个比ht[0]-&gt;table小的ht[1]-&gt;table</li>
<li>将ht[0]-&gt;table中的所有数据迁移到ht[1]-&gt;table</li>
<li>将ht[0]的数据清空，并将ht[1]替换为ht[0]</li>
</ol>
<p>判断字典的缩容的条件是在redis.c/htNeedsResize函数中，缩容是在dictReSize中完成。最后会在serverCron中被调用。</p>
<pre><code class="lang-c"><span class="hljs-keyword">int</span> htNeedsResize(dict *dict) {
    <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> size, used;

    <span class="hljs-comment">// 哈希表大小</span>
    size = dictSlots(dict);

    <span class="hljs-comment">// 哈希表已用节点数量</span>
    used = dictSize(dict);

    <span class="hljs-comment">// 当哈希表的大小大于 DICT_HT_INITIAL_SIZE(4)</span>
    <span class="hljs-comment">// 并且字典的填充率低于 REDIS_HT_MINFILL(10) 时</span>
    <span class="hljs-comment">// 返回 1</span>
    <span class="hljs-keyword">return</span> (size &amp;&amp; used &amp;&amp; size &gt; DICT_HT_INITIAL_SIZE &amp;&amp;
        (used*<span class="hljs-number">100</span>/size &lt; REDIS_HT_MINFILL));
}
</code></pre>
<h3 id="">小结</h3>
<ol>
<li>Redis字典的底层实现是哈希表，每个字典使用两个哈希表，一般情况下只使用0号哈希表，只有在rehash进行时，才会同时使用0号和1号哈希表。</li>
<li>哈希表使用链地址法来解决冲突的问题。</li>
<li>rehash可以用于扩容或者缩容哈希表。</li>
<li>对哈希表的rehash是分多次、渐进式地进行的。</li>
</ol>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../../redis/datastructure/README.html" class="navigation navigation-prev " aria-label="Previous page: redis数据结构"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../../redis/replication/README.html" class="navigation navigation-next " aria-label="Next page: replication"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../../gitbook/app.js"></script>

    
    <script src="https://cdn.mathjax.org/mathjax/2.4-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
