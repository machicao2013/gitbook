MTU和MSS
================

## MTU ##

MTU指能在网络上传输的最大数据包大小,是数据链路层的一个概念。

TCP层是第4层传输层，第3层IP网络层、第2层数据链路层具备的约束条件同样对TCP层生效。

无论何种类型的数据链路层，都会对网络分组的长度有一个限制。例如以太网限制为1500字节，802.3限制为1492字节。当内核的IP网络层试图发送报文时，若一个报文的长度大于MTU限制，就会被分成若干个小于MTU的报文，每个报文都会有独立的IP头部。

## IP报头 ##

ip报头的数据格式：

<center>![](../../imgs/package.png)</center>
<center>ip数据报格式</center>

从上图可以看到，其指定IP包总长度的是一个16位的字段，这意味一个IP包最大可以是65535个字节。若TCP层在以太网中试图发送一个大于1500字节的消息，调用网络层方法发送消息时，IP层会自动的获取所在局域网的MTU值，并按照所在网络的MTU大小来分片。IP层同时希望这个分片对于传输层来说是透明的，接收方的IP层会根据收到的多个IP包头部，将发送方IP层分片出的IP包重组为一个消息。

*这种IP层的分片效率是很差的，因为必须所有分片都到达才能重组成一个包，其中任何一个分片丢失了，都必须重发所有分片。所以，TCP层会试图避免IP层执行数据分片。*

## MSS ##

为了避免IP层的分片，TCP协议定义了一个新的概念：最大报文段长度MSS。*它定义了一个TCP连接上，一个主机期望对端主机发送单个报文的最大长度。*TCP3次握手建立连接时，连接双方都要相互告知对方自己期望接收到的MSS大小。

*这个MSS值会改变吗?*

会的。MSS就是为了避免IP层分片，在建立握手时告知对方自己期望接收的MSS值并不一定靠得住。因为这个值是预估的，TCP连接上的两台主机若处于不同的网络中，那么，连接上可能有许多个中间网络，这些网络分别具有不同的数据链路层，这样，TCP连接上有许多个MTU。若中间途径的MTU小于两台主机所在的网络的MTU时，选定的MSS仍然太大了，会导致中间路由器出现IP层的分片。

*怎样避免中间网络可能出现的分片*

通过IP头部的DF标志位，这个标志位是告诉IP报文所途经的所有IP层代码：不要对这个报文分片。如果一个IP报文太大必须要分片，则直接返回一个ICMP错误，说明必须要分片了，且带分片路由器网络接受的MTU值。这样，连接上的发送方主机就可以重新确定MSS。


